<% var favicon = 'data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABMLAAATCwAAAAAAAAAAAAAAAAAAAAAAAP///wD///8E////Pf///5n6+vrR9fX14/X19eP7+/vS////mf///zz///8E////AAAAAAAAAAAA////AP///wD///8S////hO3t7dK8vLy4f39/klpaWoJcXFyCgoKClMDAwLvv7+/U////hP///xL///8A////AP///wD///8S/f39otHR0clPT09+AQEBZAAAAGMAAABkAAAAZAAAAGMCAgJkV1dXgdfX18/+/v6j////Ev///wD///8D////hNDQ0MgmJiZvBgYGZjo6OnYpKSlxAAAAZgAAAGYqKipxOjo6dgUFBWYvLy9y19fXz////4X///8D////Pevr689MTEx8AAAAYzQ0NHTk5OTcurq6tgAAAGUAAABlvb29uOPj49swMDBzAAAAY1paWoHv7+/T////Pf///5i2trayAAAAZAAAAGU6Ojp28vLy7MjIyMEAAABlAAAAZcrKysPx8fHrNjY2dQAAAGUAAABlwMDAuv///5n4+PjNdXV1jQAAAGQAAABlOjo6dvLy8u3Jycm/AAAAYgAAAGPLy8vC8fHx6zY2NnUAAABlAAAAZIODg5T7+/vR8fHx3k1NTX0AAABlAAAAZTo6Onbx8fHr5OTk3KWlpaelpaWn5eXl3fDw8Oo2NjZ1AAAAZQAAAGRdXV2C9fX14/Hx8d1MTEx8AAAAZQAAAGU6Ojp28PDw6vn5+ffu7u7o7u7u6Pr6+vfv7+/pNjY2dQAAAGUAAABkW1tbgvX19eL4+PjNcXFxiwAAAGQAAABlOjo6dvHx8ezOzs7GMDAwczAwMHPR0dHI8PDw6zY2NnUAAABlAAAAZICAgJL7+/vQ////l7Gxsa8AAABkAAAAZTo6Onby8vLsyMjIwAAAAGQAAABky8vLwvHx8es2NjZ1AAAAZQAAAGW8vLy3////mP///z7o6OjMREREeQAAAGM5OTl28PDw6sbGxr8AAABlAAAAZcnJycHv7+/pNTU1dQAAAGNRUVF+7e3t0f///z3///8D////hMrKysMdHR1tEhISaXx8fJBcXFyCAAAAZgAAAGZeXl6De3t7kBAQEGklJSVv0dHRyf///4X///8D////AP///xL8/PyhysrKw0FBQXkAAABiAAAAYgAAAGUAAABlAAAAYgAAAGJKSkp80NDQyP39/aL///8S////AP///wD///8A////Ev7+/oTo6OjNsbGxsHBwcItLS0t8TExMfXNzc421tbWz6+vr0P///4T///8S////AP///wAAAAAAAAAAAP///wD///8E////Pf7+/pj4+PjN8fHx3vHx8d74+PjO////mP///z3///8E////AAAAAAAAAAAA4AcAAMADAACAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIABAADAAwAA4AcAAA=='; %>
<!DOCTYPE HTML>
<html lang="en-US">
<head>
  <title>HALA 图片浏览(<%= wholePath %>)</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <link rel="shortcut icon" href="<%= favicon %>" type="image/x-icon" />

  <style type="text/css">
    /* 重置 */
    body, div, dl, dt, dd, ul, ol, li, h1, h2, h3, h4, h5, h6, pre, code, form, fieldset, legend, input, button, textarea, p, blockquote, th, td {
      margin: 0;
      padding: 0;
    }
    table {
      border-collapse: collapse;
      border-spacing: 0;
    }
    caption, th {
      text-align: left;
    }
    fieldset, img, a img, iframe, html, body {
      border: 0;
    }
    li{
      list-style: none;
    }
    address, caption, cite, code, dfn, em, strong, th, var {
      font-style: normal;
      font-weight: normal;
    }
    h1, h2, h3, h4, h5, h6 {
      font-size: 100%;
      font-weight: normal;
    }
    [hidefocus] {
      outline: 0;
    }
    body {
      word-wrap: break-word;
      font: 18/normal "微软雅黑", arial, simsun;
      color: #333;
      background: #fff;
    }
    h1, h2, h3, h4, h5, h6, em, strong, b {
      font-weight: bold;
    }
    a, button {
      cursor: pointer;
      text-decoration: none;
    }

    /* 全局 */
    html, body {
      position: relative;
      height: 100%;
      width: 100%;
      overflow-y: hidden;
      font-family: "微软雅黑", "microsoft yahei", arial, simsun;
    }

    /* 清除浮动 */
    .clearfix {
      zoom: 1;
    }
    .clearfix:after {
      display: block;
      clear: both;
      visibility: hidden;
      height: 0;
      overflow: hidden;
      content: ".";
    }
    /* 省略号 */
    .ellipsis {
      overflow: hidden;
      word-wrap: normal;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .hide {
      display: none;
    }

    /* 头部 */
    .top {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;

      height: 60px;
      background: #fff;
      z-index: 100;
    }
    .title {
      padding: 20px;
      padding-left: 110px;
      font-size: 20px;
      line-height: 1;
      color: #555;
      font-weight: bold;
      text-align: center;
    }
    .back {
      padding: 10px 20px;
      position: absolute;
      top: 10px;
      font-size: 20px;
      line-height: 1;

      background: #16a085;
      color: #fff;
      cursor: pointer;
    }
    .back {
      left: 20px;
    }

    /* 内容 */
    .content {
      position: absolute;
      top: 60px;
      bottom: 60px;
      left: 0;
      right: 0;
    }

    .bg {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #909090;
      z-index: -1;
    }

    .tip {
      position: absolute;
      top: 50%;
      left: 50%;

      margin-left: -200px;
      margin-top: -50px;

      width: 400px;
      height: 100px;
      line-height: 100px;
      font-size: 20px;
      color: #222;
      text-align: center;
    }

    .imgcnt {
      position: relative;
      height: 100%;
      width: 100%;
      overflow: auto;
    }

    .imgcnt img {
      position: absolute;
      top: 0;
      left: 0;

      -webkit-transform: translate3d(0, 0, 0);
      -moz-transform: translate3d(0, 0, 0);
      -o-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);

      cursor: move;
    }

    /* 底部 */
    .bottom {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;

      height: 60px;
      background: #fff;
      z-index: 100;
    }
    .opr {
      float: left;
      margin-left: 20px;
      margin-top: 10px;

      padding: 10px 20px;
      font-size: 20px;
      line-height: 1;

      background: #16a085;
      color: #fff;
      cursor: pointer;
    }

    /* 提示语 */
    .toast {
      padding: 20px 30px;
      position: absolute;
      top: 50%;
      left: 50%;
      max-width: 80%;

      -webkit-transform: translate3d(-50%, -50%, 0);
      -moz-transform: translate3d(-50%, -50%, 0);
      -o-transform: translate3d(-50%, -50%, 0);
      transform: translate3d(-50%, -50%, 0);

      color: #fff;
      box-sizing: border-box;
    }
    .toast .bg {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;

      background: #000;
      opacity: .7;
      -webkit-opacity: .7;
      z-index: 1;
      border-radius: 5px;
    }
    .toast .text {
      position: relative;
      z-index: 2;
    }

    /* 移动端 */
    .m .top {
      transition: all .5s ease;
      -webkit-transition: all .5s ease;
    }
    .m.mhide .top {
      top: -60px;
    }
    .m .content{
      top: 0;
      bottom: 0;
    }

    .m.mhide .bottom {
      bottom: -60px;
    }
    .m .bottom {
      transition: all .5s ease;
      -webkit-transition: all .5s ease;
    }
    .m .m_bottom_hide {
      display: none;
    }
    
  </style>
</head>
<body>
  <div class="top">
    <div id="back" class="back">返回</div>
    <div id="title" class="title ellipsis"></div>
  </div>
  <div class="content">
    <div class="bg"></div>

    <% if(!images.length) { %>
    <div class="tip">当前目录下没有图片可浏览</div>
    <% } else { %>
    <div id="imgcnt" class="imgcnt">
      <% images.forEach(function(item, index) { %>
      
      <% if(index < 5) { %>
      <img src="<%= item.path %>" title="<%= item.name %>" alt="<%= item.name %>" class="<% if(index!==0) { %>hide<% } %>" style="max-width: 100%;">
      <% } else { %>
      <img src="" data-src="<%= item.path %>" title="<%= item.name %>" alt="<%= item.name %>" class="<% if(index!==0) { %>hide<% } %>" style="max-width: 100%;">
      <% } %>

      <% }); %>
    </div>
    <% } %>

  </div>
  <div class="bottom">
    <div class="clearfix">
      <div id="prev" class="opr">上一页</div>
      <div id="next" class="opr">下一页</div>
      <div id="bigger" class="opr m_bottom_hide">放大</div>
      <div id="smaller" class="opr m_bottom_hide">缩小</div>
      <div id="left_rotate" class="opr m_bottom_hide">左旋</div>
      <div id="right_rotate" class="opr m_bottom_hide">右旋</div>
      <div id="overturn" class="opr m_bottom_hide">翻转</div>
      <div id="reset" class="opr m_bottom_hide">重置</div>
      <div id="real" class="opr m_bottom_hide">实际大小</div>
    </div>
  </div>

  <div class="toast hide">
    <div class="bg"></div>
    <div id="toast" class="text"></div>
  </div>

  <script type="text/javascript">
    var ua = navigator.userAgent;
    var isSymbian = /(?:SymbianOS)/.test(ua) || /(?:Windows Phone)/.test(ua);
    var isAndroid = /(?:Android)/.test(ua);
    var isTablet = /(?:iPad|PlayBook)/.test(ua) || (isAndroid && !/(?:Mobile)/.test(ua)) || (/(?:Firefox)/.test(ua) && /(?:Tablet)/.test(ua));
    var isPhone = /(?:iPhone)/.test(ua) && !isTablet;

    var isPc = !isPhone && !isAndroid && !isSymbian;

    if(!isPc) {
      // 增加样式区分
      addClass(document.body, 'm');
      // 增加移动端手势事件
      (function(){function f(a){return Math.sqrt(a.x*a.x+a.y*a.y)}var h=function(a,b){a.addEventListener("touchstart",this.st.bind(this),!1);a.addEventListener("touchmove",this.mv.bind(this),!1);a.addEventListener("touchend",this.end.bind(this),!1);a.addEventListener("touchcancel",this.cancel.bind(this),!1);this.preV={x:null,y:null};this.psl=null;this.scale=1;this.idt=!1;this.ro=b.rotate||function(){};this.ts=b.touchStart||function(){};this.mps=b.multipointStart||
      function(){};this.mpe=b.multipointEnd||function(){};this.p=b.pinch||function(){};this.swipe=b.swipe||function(){};this.tap=b.tap||function(){};this.dt=b.doubleTap||function(){};this.lt=b.longTap||function(){};this.sit=b.singleTap||function(){};this.pem=b.pressMove||function(){};this.tm=b.touchMove||function(){};this.te=b.touchEnd||function(){};this.toc=b.touchCancel||function(){};this.x1=this.x2=this.y1=this.y2=this.swt=this.ltt=
      this.tot=this.tat=this.now=this.last=this.delta=null;this.ptp={x:null,y:null}};h.prototype={st:function(a){if(a.touches){this.now=Date.now();this.x1=a.touches[0].pageX;this.y1=a.touches[0].pageY;this.delta=this.now-(this.last||this.now);this.ts(a);null!==this.ptp.x&&(this.idt=0<this.delta&&250>=this.delta&&30>Math.abs(this.ptp.x-this.x1)&&30>Math.abs(this.ptp.y-this.y1));this.ptp.x=this.x1;this.ptp.y=
      this.y1;this.last=this.now;var b=this.preV;if(1<a.touches.length){this._clt();var c=a.touches[1].pageY-this.y1;b.x=a.touches[1].pageX-this.x1;b.y=c;this.psl=f(b);this.mps(a)}this.ltt=setTimeout(function(){this.lt(a)}.bind(this),750)}},mv:function(a){if(a.touches){var b=this.preV,c=a.touches.length,e=a.touches[0].pageX,g=a.touches[0].pageY;this.idt=!1;if(1<c){c={x:a.touches[1].pageX-e,y:a.touches[1].pageY-g};if(null!==b.x){0<this.psl&&
      (a.scale=f(c)/this.psl,this.p(a));var d;d=f(c)*f(b);0===d?d=0:(d=(c.x*b.x+c.y*b.y)/d,1<d&&(d=1),d=Math.acos(d));0<c.x*b.y-b.x*c.y&&(d*=-1);a.angle=180*d/Math.PI;this.ro(a)}b.x=c.x;b.y=c.y}else null!==this.x2?(a.deltaX=e-this.x2,a.deltaY=g-this.y2):(a.deltaX=0,a.deltaY=0),this.pem(a);this.tm(a);this._clt();this.x2=e;this.y2=g;1<a.touches.length&&(this._clt(),a.preventDefault())}},end:function(a){if(a.changedTouches){this._clt();var b=this;
      2>a.touches.length&&this.mpe(a);this.te(a);this.x2&&30<Math.abs(this.x1-this.x2)||this.y2&&30<Math.abs(this.preV.y-this.y2)?(a.direction=this._sd(this.x1,this.x2,this.y1,this.y2),this.swt=setTimeout(function(){b.swipe(a)},0)):this.tat=setTimeout(function(){b.tap(a);b.idt?(b.dt(a),clearTimeout(b.tot),b.idt=!1):b.tot=setTimeout(function(){b.sit(a)},250)},0);this.preV.x=0;this.preV.y=0;this.scale=1;this.x1=this.x2=
      this.y1=this.y2=this.psl=null}},cancel:function(a){clearTimeout(this.tot);clearTimeout(this.tat);clearTimeout(this.ltt);clearTimeout(this.swt);this.toc(a)},_clt:function(){clearTimeout(this.ltt)},_sd:function(a,b,c,e){return Math.abs(a-b)>=Math.abs(c-e)?0<a-b?"Left":"Right":0<c-e?"Up":"Down"}};window.T=h})();
    }

    /**
     * 事件添加器
     */
    function addEvent(elem, event, callback) {
      if(window.addEventListener) {
        elem.addEventListener(event, callback, false);
      } else {
        elem.attachEvent('on' + event, callback);
      }
    }

    /**
     * 获取某个dom节点的类列表
     */
    function hasClass(elem, className) {
      var classList = elem.className.split(' ');
      for(var i=0,len=classList.length; i<len; i++) {
        if(classList[i].trim() === className) return true;
      }

      return false;
    }

    /**
     * 增加某个dom节点的类
     */
    function addClass(elem, className) {
      if(!hasClass(elem, className)) {
        elem.className += (' ' + className);
      }
    }

    /**
     * 删除某个dom节点的类
     */
    function removeClass(elem, className) {
      var classList = elem.className.split(' ');
      for(var i=classList.length-1; i>=0; i--) {
        if(classList[i].trim() === className) classList.splice(i, 1);
      }

      elem.className = classList.join(' ');
    }



    var toast = document.getElementById('toast');
    var toastCnt = toast.parentNode;
    var imgcnt = document.getElementById('imgcnt');
    var imgs = imgcnt.getElementsByTagName('img');
    var title = document.getElementById('title');
    var backBtn = document.getElementById('back');
    var imgsLen = imgs.length;

    var oprs = {
      prev: document.getElementById('prev'),
      next: document.getElementById('next'),
      bigger: document.getElementById('bigger'),
      smaller: document.getElementById('smaller'),
      left_rotate: document.getElementById('left_rotate'),
      right_rotate: document.getElementById('right_rotate'),
      overturn: document.getElementById('overturn'),
      reset: document.getElementById('reset'),
      real: document.getElementById('real')
    };

    if(imgsLen) {
      // 初始化第一个图片
      title.innerHTML = imgs[0].title;
      title.title = imgs[0].title;
    }

    /**
     * 显示提示
     */
    function showToast(text) {
      toast.innerHTML = text || '';
      removeClass(toastCnt, 'hide');

      setTimeout(function() {
        addClass(toastCnt, 'hide');
      }, 1000);
    }

    /**
     * 获取当前显示的图片
     */
    function getCurrent() {
      for(var i=imgsLen-1; i>=0; i--) {
        if(!hasClass(imgs[i], 'hide')) break;
      }

      if(i < imgsLen) {
        return {
          elem: imgs[i],
          index: i
        };
      } else {
        return null;
      }
    }

    /**
     * 居中图片
     */
    function middle(img) {
      getImgNaturalDimensions(img, function(iw, ih) {
        var vw = imgcnt.clientWidth;
        var vh = imgcnt.clientHeight;
        var isAuto = !!(img.style.maxWidth === '100%');
        var isScale = !!(img.style.width !== iw+'px');

        if(isAuto && vw < iw) {
          // 当屏幕上图片宽度被自适应时
          ih = vw * ih / iw; // 获取屏幕上真实高度
        }
        if(!isAuto && isScale) {
          // 当屏幕上图片宽度被缩放过时
          var rw = parseInt(img.style.width, 10);
          ih = rw * ih / iw; // 获取屏幕上真实高度
          iw = rw;
        }

        var left = vw > iw ? (vw-iw)/2 : 0;
        var top = vh > ih ? (vh-ih)/2 : 0;


        img.style.left = left + 'px';
        img.style.top = top + 'px';
      });
    }
    // 全部先做一次居中处理
    for(var i=0; i<imgsLen; i++) {
      middle(imgs[i]);
    }

    /**
     * 是否可滚动
     */
    function isScroll() {
      return imgcnt.clientHeight < imgcnt.scrollHeight || imgcnt.clientWidth < imgcnt.scrollWidth;
    }
    function isXScroll() {
      return imgcnt.clientWidth < imgcnt.scrollWidth;
    }

    /**
     * 懒加载
     */
    function lazyLoad(index) {
      for(var i=index; i<index+5; i++) {
        var elem = imgs[i];
        if(elem && elem.dataset && elem.dataset.src) {
          elem.src = elem.dataset.src;
          elem.dataset.src = '';

          elem.onload = function() {
            // 加载完居中
            elem.onload = null;
            middle(elem);
          };
        }
      }
    }

    /**
     * 翻页
     */
    function toPage(arrow) {
      var index = 0;
      var elem = imgs[index];

      var obj = getCurrent();
      if(obj) {
        index = obj.index;
        elem = obj.elem;
      }

      var nIndex, nElem;
      switch(arrow) {
        case 'up':
          // 上一页
          nIndex = index <= 0 ? imgsLen - 1 : index - 1;
          break;
        case 'down':
          // 下一页
          nIndex = index >= imgsLen - 1 ? 0 : index + 1;
          lazyLoad(nIndex);
          break;
        default: 
          break;
      }
      nElem = imgs[nIndex];

      reset();
      addClass(elem, 'hide');
      removeClass(nElem, 'hide');
      middle(nElem);
      title.innerHTML = nElem.title;
      title.title = nElem.title;
    }

    /**
     * 展示头尾
     */
    function showTopAndBottom(cb) {
      removeClass(document.body, 'mhide');

      setTimeout(function() {
        addClass(document.body, 'mhide');
        cb&&(typeof cb === 'function')&&cb();
      }, 2000);
    }

    /**
     * 获取图片实际大小
     */
    function getImgNaturalDimensions(img, cb) {
      if(img.naturalWidth) {
        cb(img.naturalWidth, img.naturalHeight);
      } else { 
        // IE6/7/8
        var tmp = new Image();
        tmp.src = img.src;
        tmp.onload = function() {
          cb(tmp.width, tmp.height);
          tmp.onload = null;
        };
      }
    }

    /**
     * 放大或缩小
     */
    var biggerType = 0; // 0 - 原状，1 - 放大1次，2 - 放大两次
    function scale(type, num) {
      var obj = getCurrent();
      var elem = obj.elem;

      var setWAndH = function(elem, toW) {
        elem.style.maxWidth = toW + 'px';
        elem.style.width = toW + 'px';
      };

      getImgNaturalDimensions(elem, function(w, h) {
        var nw = elem.width;
        var nh = elem.height;

        if(type === 'bigger') {
          // 放大
          var maxW = w * 5; // 最大放大到实际的500%
          var toW = nw * (num || 1.2);

          if(toW < maxW) {
            setWAndH(elem, toW);
          }
        } else if(type === 'smaller') {
          // 缩小
          var minW = w / 20; // 最小缩小到实际的5%
          var toW = nw * (num || 0.8);

          if(toW > minW) {
            setWAndH(elem, toW);
          }
        } else if(type === 'real') {
          // 实际大小 
          setWAndH(elem, w);
        } else if(type === 'reset') {
          // 恢复原状
          elem.style.maxWidth = '100%';
          elem.style.width = 'auto';
        }

        middle(elem); // 居中处理
      });      
    }

    var transformPrefix = 'translate3d(0, 0, 0) ';
    /**
     * 旋转
     */
    var nowRotate = 0;
    function rotate(type) {
      var obj = getCurrent();
      var elem = obj.elem;

      var rotateStr = 'rotate(';
      if(type === 'right') {
        // 右旋
        nowRotate += 90;
      } else if(type === 'left') {
        // 左旋
        nowRotate -= 90;
      }

      if(nowRotate >= 360) nowRotate -= 360;
      if(nowRotate <= 360) nowRotate += 360;

      elem.style.webkitTransform  = transformPrefix + rotateStr + nowRotate + 'deg)';
      elem.style.MozTransform = transformPrefix + rotateStr + nowRotate + 'deg)';
      elem.style.OTransform = transformPrefix + rotateStr + nowRotate + 'deg)';
      elem.style.transform = transformPrefix + rotateStr + nowRotate + 'deg)';

      middle(elem); // 居中处理
    }

    /**
     * 翻转
     */
    var isOverturn = false;
    function overturn() {
      var setScale = function(str) {
        imgcnt.style.webkitTransform  = str;
        imgcnt.style.MozTransform = str;
        imgcnt.style.OTransform = str;
        imgcnt.style.transform = str;
      };

      if(isOverturn) {
        setScale('');
      } else {
        setScale('scaleX(-1)');
      }
      isOverturn = !isOverturn;
    }

    /**
     * 移动
     */
    function move(x, y) {
      imgcnt.scrollLeft += x;
      imgcnt.scrollTop += y;
    }

    /**
     * 重置
     */
    function reset() {
      var obj = getCurrent();
      var elem = obj.elem;

      // 恢复放大缩小
      biggerType = 0;
      elem.style.maxWidth = '100%';
      elem.style.width = 'auto';

      // 恢复旋转
      nowRotate = 0;
      elem.style.webkitTransform  = transformPrefix;
      elem.style.MozTransform = transformPrefix;
      elem.style.OTransform = transformPrefix;
      elem.style.transform = transformPrefix;

      // 恢复翻转
      isOverturn = false;
      imgcnt.style.webkitTransform  = '';
      imgcnt.style.MozTransform = '';
      imgcnt.style.OTransform = '';
      imgcnt.style.transform = '';

      // 恢复移动
      imgcnt.scrollTop = 0;
      imgcnt.scrollLeft = 0;

      middle(elem); // 居中处理
    }

    if(!isPc) {
      // 移动端
      showTopAndBottom();

      new T(imgcnt, {
        touchMove: function(evt) {
          // 阻止默认事件
          evt.preventDefault();
        },
        singleTap: function() {
          // 按图片显示头尾
          showTopAndBottom();
        },
        swipe: function(evt) {
          if(isXScroll()) return; // 可滚动状态不翻页

          if(evt.direction.toLowerCase() === 'left') {
            // 下一页
            toPage('down');
          } else if(evt.direction.toLowerCase() === 'right') {
            // 上一页
            toPage('up');
          }
        },
        doubleTap: function() {
          // 双击放大，放大两次后恢复原状
          if(biggerType < 2) {
            scale('bigger', 1.8); 
            biggerType ++;
          } else {
            scale('reset');
            biggerType = 0;
          }
        },
        pinch: function(evt) {
          // 放大缩小
          // TODO
          console.log(evt.scale);
        },
        pressMove: (function() {
          var deltaX = deltaY = 0;
          var isMoving = false;
          return function(evt) {
            // 拖动
            deltaX += evt.deltaX;
            deltaY += evt.deltaY;
            if(isMoving || !isScroll()) return;

            move(-deltaX, -deltaY);
            deltaX = deltaY = 0;
            
            // 节流
            isMoving = true;
            setTimeout(function() {isMoving = false;}, 100);
          }
        })()
      });

      new T(title, {
        tap: function(evt) {
          // 按标题展示标题内容
          var text = title.innerHTML;
          showToast(text);
        }
      });

      new T(backBtn, {tap: back});

      new T(oprs['prev'], {tap: function() {toPage('up');}});
      new T(oprs['next'], {tap: function() {toPage('down');}});
    } else {
      // pc端
      var support = 'onwheel' in document.createElement('div') ? 'wheel' // 各个厂商的高版本浏览器都支持 wheel
        : document.onmousewheel !== undefined ? 'mousewheel' // Webkit 和 IE一定支持 mousewheel
        : 'MozMousePixelScroll'; // 低版本firefox

      /**
       * 滚轮事件添加器
       */
      var addWheelEvent = function(elem, callback) {
        addEvent(document, support, support === 'wheel' ? callback : function(evt) {
          evt = evt || window.event;

          // 生成新的事件对象
          var event = {
            originalEvent: evt,
            target: evt.target || evt.srcElement,
            type: 'wheel',
            deltaMode: evt.type == 'MozMousePixelScroll' ? 0 : 1,
            deltaX: 0,
            deltaZ: 0,
            preventDefault: function() {
              return evt.preventDefault ? evt.preventDefault() : evt.returnValue = false;
            }
          };

          // 修复偏移值
          if(support === 'mousewheel') {
            event.deltaY = - 1/40 * evt.wheelDelta;
            evt.wheelDeltaX && ( event.deltaX = - 1/40 * evt.wheelDeltaX );
          } else {
            event.deltaY = evt.detail;
          }

          return callback(event);
        });
      };

      addWheelEvent(document, function(evt) {
        if(evt.deltaY > 0) {
          // 下一页
          toPage('down');
        } else {
          // 上一页
          toPage('up');
        }
      });

      // 拖拽移动
      var isMouseDown = false;
      var isMoving = false;
      var cacheObj = {x: 0, y: 0};
      addEvent(imgcnt, 'mousedown', function(evt) {
        evt = evt || window.event;

        isMouseDown = true;
        cacheObj.x = evt.screenX;
        cacheObj.y = evt.screenY;
      });
      addEvent(window, 'mousemove', function(evt) {
        evt = evt || window.event;
        evt.preventDefault ? evt.preventDefault() : evt.returnValue = false;

        if(isMoving || !isMouseDown || !isScroll()) return;

        var ox = cacheObj.x
        var oy = cacheObj.y
        cacheObj.x = evt.screenX;
        cacheObj.y = evt.screenY;

        move(ox - cacheObj.x, oy - cacheObj.y);

        // 节流
        isMoving = true;
        setTimeout(function() {isMoving = false;}, 100);
      });
      addEvent(window, 'mouseup', function(evt) {
        isMouseDown = false;
        cacheObj.x = 0;
        cacheObj.y = 0;
      });

      // 添加返回事件
      addEvent(backBtn, 'click', back);

      addEvent(oprs['prev'], 'click', function() {toPage('up');});
      addEvent(oprs['next'], 'click', function() {toPage('down');});
      addEvent(oprs['bigger'], 'click', function() {scale('bigger');});
      addEvent(oprs['smaller'], 'click', function() {scale('smaller');});
      addEvent(oprs['left_rotate'], 'click', function() {rotate('left');});
      addEvent(oprs['right_rotate'], 'click', function() {rotate('right');});
      addEvent(oprs['overturn'], 'click', function() {overturn();});
      addEvent(oprs['reset'], 'click', function() {reset();});
      addEvent(oprs['real'], 'click', function() {scale('real');});
    }

    // 窗口变化需要重新居中
    var isResizing = false;
    addEvent(window, 'resize', function() {
      if(isResizing) return;

      var obj = getCurrent();
      var elem = obj.elem;

      middle(elem); // 居中处理

      // 节流
      isResizing = true;
      setTimeout(function() {isResizing = false;}, 100);
    });

    /**
     * 返回
     */
    function back() {
      location.href = '<%= pathname %>';
    }

  </script>
</body>
</html>
